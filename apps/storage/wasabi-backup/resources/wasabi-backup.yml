---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob
spec:
  schedule: '15 3 * * *'
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          nodeSelector:
            kubernetes.io/hostname: drone-04
          containers:
            - name: rclone
              image: rclone/rclone:1.72@sha256:0eb18825ac9732c21c11d654007170572bbd495352bb6dbb624f18e4f462c496
              envFrom:
                - secretRef:
                    name: wasabi-backup-secret
              env:
                - name: RCLONE_CONFIG_WASABI_TYPE
                  value: s3
                - name: RCLONE_CONFIG_WASABI_PROVIDER
                  value: Wasabi
                - name: RCLONE_CONFIG_WASABI_ENDPOINT
                  value: s3.wasabisys.com
                - name: RCLONE_CONFIG_WASABI_REGION
                  value: us-east-1
              command:
                - rclone
                - sync
                - /backup
                - wasabi:beaver-cloud-rust-backups
                - --fast-list
                - --s3-chunk-size=64M
                - --s3-upload-concurrency=4
                - -v
              securityContext:
                privileged: true
              volumeMounts:
                - name: rust-backups
                  mountPath: /backup
                  readOnly: true
          volumes:
            - name: rust-backups
              hostPath:
                path: /var/mnt/rust/backup

---
apiVersion: k8s.bitwarden.com/v1
kind: BitwardenSecret
metadata:
  name: secret
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  organizationId: 575f69b2-49f4-456d-bd6f-b14101103188
  secretName: wasabi-backup-secret
  map:
    - secretKeyName: RCLONE_CONFIG_WASABI_ACCESS_KEY_ID
      bwSecretId: d195fd5e-4219-4066-9867-b3b7010e63d5
    - secretKeyName: RCLONE_CONFIG_WASABI_SECRET_ACCESS_KEY
      bwSecretId: 068aec9d-693c-459e-ac6c-b3b7010e750e
  authToken:
    secretName: bw-auth-token
    secretKey: token
