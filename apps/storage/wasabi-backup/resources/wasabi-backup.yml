---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: rust-backup-cronjob
spec:
  suspend: true
  schedule: '15 3 * * *'
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          nodeSelector:
            kubernetes.io/hostname: drone-04
          containers:
            - name: rclone
              image: rclone/rclone:1.73@sha256:9f59fda717a48aced38d7f27e9ec8fd9992b5651e7a03897bebf204d3a9197d6
              envFrom:
                - secretRef:
                    name: wasabi-backup-secret
              env:
                - name: RCLONE_CONFIG_WASABI_TYPE
                  value: s3
                - name: RCLONE_CONFIG_WASABI_PROVIDER
                  value: Wasabi
                - name: RCLONE_CONFIG_WASABI_ENDPOINT
                  value: s3.wasabisys.com
                - name: RCLONE_CONFIG_WASABI_REGION
                  value: us-east-1
                - name: RCLONE_CONFIG_ENCRYPTED_TYPE
                  value: crypt
                - name: RCLONE_CONFIG_ENCRYPTED_REMOTE
                  value: wasabi:beaver-cloud-rust-backups
                - name: RCLONE_CONFIG_ENCRYPTED_FILENAME_ENCRYPTION
                  value: standard
                - name: RCLONE_CONFIG_ENCRYPTED_DIRECTORY_NAME_ENCRYPTION
                  value: 'true'
              command:
                - rclone
                - copy
                - /backup
                - 'encrypted:'
                - --fast-list
                - --s3-chunk-size=64M
                - --s3-upload-concurrency=4
                - --bwlimit=2M:off
                - --copy-links
                - -v
              securityContext:
                privileged: true
              volumeMounts:
                - name: rust-backups
                  mountPath: /backup
                  readOnly: true
          volumes:
            - name: rust-backups
              hostPath:
                path: /var/mnt/rust/backup

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: immich-cronjob
spec:
  suspend: true
  schedule: '16 1 * * *'
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          nodeSelector:
            kubernetes.io/hostname: drone-04
          containers:
            - name: rclone
              image: rclone/rclone:1.73@sha256:9f59fda717a48aced38d7f27e9ec8fd9992b5651e7a03897bebf204d3a9197d6
              envFrom:
                - secretRef:
                    name: wasabi-backup-secret
              env:
                - name: RCLONE_CONFIG_WASABI_TYPE
                  value: s3
                - name: RCLONE_CONFIG_WASABI_PROVIDER
                  value: Wasabi
                - name: RCLONE_CONFIG_WASABI_ENDPOINT
                  value: s3.wasabisys.com
                - name: RCLONE_CONFIG_WASABI_REGION
                  value: us-east-1
                - name: RCLONE_CONFIG_ENCRYPTED_TYPE
                  value: crypt
                - name: RCLONE_CONFIG_ENCRYPTED_REMOTE
                  value: wasabi:beaver-cloud-immich-backups
                - name: RCLONE_CONFIG_ENCRYPTED_FILENAME_ENCRYPTION
                  value: standard
                - name: RCLONE_CONFIG_ENCRYPTED_DIRECTORY_NAME_ENCRYPTION
                  value: 'true'
              command:
                - rclone
                - copy
                - /backup
                - 'encrypted:'
                - --fast-list
                - --s3-chunk-size=64M
                - --s3-upload-concurrency=4
                - --bwlimit=2M:off
                - --copy-links
                - -v
              securityContext:
                privileged: true
              volumeMounts:
                - name: immich
                  mountPath: /backup
                  readOnly: true
          volumes:
            - name: immich
              hostPath:
                path: /var/mnt/rust/media/immich

---
apiVersion: k8s.bitwarden.com/v1
kind: BitwardenSecret
metadata:
  name: secret
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  organizationId: 575f69b2-49f4-456d-bd6f-b14101103188
  secretName: wasabi-backup-secret
  map:
    - secretKeyName: RCLONE_CONFIG_WASABI_ACCESS_KEY_ID
      bwSecretId: d195fd5e-4219-4066-9867-b3b7010e63d5
    - secretKeyName: RCLONE_CONFIG_WASABI_SECRET_ACCESS_KEY
      bwSecretId: 068aec9d-693c-459e-ac6c-b3b7010e750e
    - secretKeyName: RCLONE_CONFIG_ENCRYPTED_PASSWORD
      bwSecretId: dbf14621-b507-4cf8-b032-b3b70115dc55
  authToken:
    secretName: bw-auth-token
    secretKey: token
