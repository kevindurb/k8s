---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: volume
spec:
  accessModes: [ReadWriteOnce]
  storageClassName: openebs-zfspv
  # dataSourceRef:
  #   kind: ReplicationDestination
  #   apiGroup: volsync.backube
  #   name: n8n-volume
  resources:
    requests:
      storage: 1G

---
apiVersion: k8s.bitwarden.com/v1
kind: BitwardenSecret
metadata:
  name: restic-config
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  organizationId: 575f69b2-49f4-456d-bd6f-b14101103188
  secretName: n8n-restic-config
  map:
    - secretKeyName: RESTIC_REPOSITORY
      bwSecretId: 365c4ecb-4f09-4df1-a525-b36a010986f5
    - secretKeyName: RESTIC_PASSWORD
      bwSecretId: b90148ba-a111-4dd0-b463-b369010605d0
    - secretKeyName: AWS_ACCESS_KEY_ID
      bwSecretId: 197d1663-cad4-408f-9e1a-b368015486b6
    - secretKeyName: AWS_SECRET_ACCESS_KEY
      bwSecretId: 94935732-b65c-48fe-9126-b3680154a72b
  authToken:
    secretName: bw-auth-token
    secretKey: token

---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: volume
spec:
  sourcePVC: n8n-volume
  trigger:
    schedule: '*/30 * * * *'
  restic:
    pruneIntervalDays: 7
    volumeSnapshotClassName: openebs-zfspv
    repository: n8n-restic-config
    retain:
      hourly: 6
      daily: 5
      weekly: 4
      monthly: 2
      yearly: 1
    copyMethod: Snapshot

---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: volume
spec:
  trigger:
    manual: restore-once
  restic:
    repository: n8n-restic-config
    copyMethod: Snapshot
    capacity: 1G
    storageClassName: openebs-zfspv
    volumeSnapshotClassName: openebs-zfspv
    accessModes: [ReadWriteOnce]
