---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment
  annotations:
    reloader.stakater.com/auto: 'true'
  labels: &labels
    app.kubernetes.io/component: wg
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels: *labels
  template:
    metadata:
      labels: *labels
    spec:
      volumes:
        - name: config
          configMap:
            name: config
        - name: key
          secret:
            secretName: wg-secret
            items:
              - key: wg0.key
                path: wg0.key
      containers:
        - name: wg
          image: ghcr.io/kevindurb/wireguard:2025.11.21
          resources:
            requests:
              memory: 100M
            limits:
              memory: 1G
          volumeMounts:
            - name: config
              mountPath: /etc/wireguard/wg0.conf
              subPath: wg0.conf
              readOnly: true
            - name: key
              mountPath: /etc/wireguard/wg0.key
              subPath: wg0.key
              readOnly: true
          securityContext:
            capabilities:
              add: [NET_ADMIN, SYS_MODULE]
          ports:
            - name: wg
              containerPort: 51820
              protocol: UDP

---
apiVersion: k8s.bitwarden.com/v1
kind: BitwardenSecret
metadata:
  name: secret
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  organizationId: 575f69b2-49f4-456d-bd6f-b14101103188
  secretName: wg-secret
  map:
    - secretKeyName: wg0.key
      bwSecretId: 0d390d6d-7c5e-4234-9319-b39c015fba89
  authToken:
    secretName: bw-auth-token
    secretKey: token

---
apiVersion: v1
kind: Service
metadata:
  name: service
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.42.42
  selector:
    app.kubernetes.io/component: wg
  ports:
    - name: wg
      port: 51820
      protocol: UDP
      targetPort: wg

---
apiVersion: externaldns.k8s.io/v1alpha1
kind: DNSEndpoint
metadata:
  name: endpoint
spec:
  endpoints:
    - dnsName: wg.beaver-cloud.xyz
      recordType: A
      targets: [192.168.42.42]
