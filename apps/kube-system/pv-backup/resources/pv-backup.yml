apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob
spec:
  schedule: '0 0 * * *' # runs daily at midnight
  jobTemplate:
    spec:
      securityContext:
        fsGroup: 1000
      template:
        spec:
          serviceAccountName: service-account
          restartPolicy: OnFailure
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            readOnlyRootFilesystem: true
          capabilities:
            drop: [ALL]
          containers:
            - name: pv-backup
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - kubectl get pv -o yaml > /data/pvs.yml
              volumeMounts:
                - name: volume
                  mountPath: /data
          volumes:
            - name: volume
              persistentVolumeClaim:
                claimName: volume
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: volume
spec:
  accessModes: [ReadWriteOnce]
  storageClassName: openebs-zfspv
  resources:
    requests:
      storage: 1Gi

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: service-account

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: role
rules:
  - apiGroups: ['']
    resources: [persistentvolumes]
    verbs: [get, list]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: role
subjects:
  - kind: ServiceAccount
    name: service-account
