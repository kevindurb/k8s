apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob
spec:
  schedule: '0 * * * *'
  jobTemplate:
    spec:
      template:
        spec:
          securityContext:
            fsGroup: 1000
          serviceAccountName: service-account
          restartPolicy: OnFailure
          containers:
            - name: pv-backup
              image: bitnami/kubectl:latest@sha256:3bcc3efefff77a4dd3ec1886e612c249dc6a313fada8348e42ec2ebe9168126f
              command:
                - /bin/sh
                - -c
                - >
                  echo "=== Exporting PersistentVolumes ===" &&
                  kubectl get pv -o yaml | tee /data/pvs.yml &&
                  echo "=== PersistentVolumes successfully saved to /data/pvs.yml ==="
              securityContext:
                privileged: false
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 1000
                readOnlyRootFilesystem: true
              volumeMounts:
                - name: volume
                  mountPath: /data
          volumes:
            - name: volume
              persistentVolumeClaim:
                claimName: volume
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: volume
spec:
  accessModes: [ReadWriteOnce]
  storageClassName: openebs-zfspv
  resources:
    requests:
      storage: 1Gi

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: service-account

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-role
rules:
  - apiGroups: ['']
    resources: [persistentvolumes]
    verbs: [get, list]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-role
subjects:
  - kind: ServiceAccount
    name: service-account
