---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: daemonset
  labels: &labels
    app.kubernetes.io/component: curl
spec:
  selector:
    matchLabels: *labels
  template:
    metadata:
      labels: *labels
    spec:
      tolerations:
        - operator: 'Exists'
      containers:
        - name: healthchecks
          image: curlimages/curl:8.10.1
          env:
            - name: PING_KEY
              valueFrom:
                secretKeyRef:
                  name: healthchecks-secret
                  key: PING_KEY
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          command:
            - /bin/sh
            - -c
            - |
              while true; do
                echo "[$(date -Iseconds)] Pinging Healthchecks.io for node ${NODE_NAME}..."
                curl -fsS --max-time 10 --retry 3 --retry-delay 5 \
                  "https://hc-ping.com/${PING_KEY}/${NODE_NAME}" \
                  && echo "Ping OK" || echo "Ping failed for ${NODE_NAME}"
                sleep 300  # wait 5 minutes
              done
      restartPolicy: Always

---
apiVersion: k8s.bitwarden.com/v1
kind: BitwardenSecret
metadata:
  name: secret
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  organizationId: 575f69b2-49f4-456d-bd6f-b14101103188
  secretName: healthchecks-secret
  map:
    - secretKeyName: PING_KEY
      bwSecretId: c2de218d-7420-44e9-8b46-b386011fe820
  authToken:
    secretName: bw-auth-token
    secretKey: token
