FROM ghcr.io/ublue-os/ucore-minimal:stable-nvidia

ARG K8S_VERSION

ADD ./files/modules.conf /etc/modules-load.d/k8s.conf
ADD ./files/sysctl.conf /etc/sysctl.d/k8s.conf

RUN dnf install -y \
    kubernetes${K8S_VERSION} \
    kubernetes${K8S_VERSION}-kubeadm \
    kubernetes${K8S_VERSION}-client \
    cri-o \
    containernetworking-plugins \
    && dnf clean all

RUN sudo dnf versionlock add kubernetes*-${K8S_VERSION}.* cri-o-${K8S_VERSION}.*

RUN dnf remove -y \
  zram-generator-defaults

RUN systemctl disable firewalld \
    && systemctl enable crio \
    && systemctl enable kubelet
