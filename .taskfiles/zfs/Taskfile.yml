# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: '3'

tasks:
  zpool-status: ssh core@{{.HOST}} 'zpool status'
  zfs-list: ssh core@{{.HOST}} 'zfs list'
  zpool-status-all: pssh -i -h ./hosts/agents 'zpool status'
  zfs-list-all: pssh -i -h ./hosts/agents 'zfs list'

  enable-sanoid:
    cmd:
      task: on:agents
      vars:
        CMD: sudo systemctl enable sanoid-prune.service && sudo systemctl enable --now sanoid.timer

  setup-scrub:
    - task: on:agents
      vars:
        CMD: sudo systemctl enable --now zfs-scrub-weekly@tank.timer
    - task: on:node
      vars:
        NODE: drone-04
        CMD: sudo systemctl enable --now zfs-scrub-monthly@rust.timer

  wipefs:
    prompt: About to WIPE /dev/nvme0n1 on {{.HOST}}! Are you sure you want to continue?
    cmd:
      task: on:node
      vars:
        NODE: '{{.HOST}}'
        CMD: sudo wipefs -a /dev/nvme0n1

  zpool-create: ssh core@{{.HOST}} 'sudo zpool create tank -m /var/mnt/tank /dev/nvme0n1'
  zfs-create: ssh core@{{.HOST}} 'sudo zfs create -o compression=lz4 tank/storage'

  build-all:
    cmds:
      - for: { var: agents }
        task: wipefs
        vars: { HOST: '{{.ITEM.hostname}}' }
      - for: { var: agents }
        task: zpool-create
        vars: { HOST: '{{.ITEM.hostname}}' }
      - for: { var: agents }
        task: zfs-create
        vars: { HOST: '{{.ITEM.hostname}}' }
