# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: '3'

includes:
  bws:
    taskfile: ../bitwarden/Taskfile.yml
    internal: true

env:
  NS: '{{.NS}}'
  APP: '{{.APP}}'
  COMP: '{{or .COMP "web"}}'
  IMG: '{{.IMG}}'
  PORT: '{{or .PORT "80"}}'
  PROTO: '{{or .PROTO "http"}}'
  SUBDOMAIN: '{{or .SUBDOMAIN .APP}}'
  IP: '{{.IP}}'
  SIZE: '{{or .size "1G"}}'
  APP_DIR: '{{.APP_DIR}}'
  HELM_REPO: '{{.HELM_REPO}}'
  HELM_VERSION: '{{.HELM_VERSION}}'

vars:
  APP_DIR: '{{list "apps" .NS .APP | join "/" | clean}}'
  TEMPLATES_DIR: '{{.ROOT_DIR}}/.taskfiles/templates/resources'
  MINIJINJA_ARGS: >-
    --env
    --trim-blocks
    --lstrip-blocks
    --autoescape=none

tasks:
  mk:
    cmds:
      - task: app
      - task: kustomization
      - task: gatus
      - task: app-resources

  mk-helm:
    cmds:
      - task: helm-app
      - task: kustomization
      - task: gatus
      - task: app-resources

  minijinja:
    internal: true
    requires:
      vars: [OUT_FILE, TEMPLATE]
    sources:
      - '{{.TEMPLATES_DIR}}/{{.TEMPLATE}}.yml.j2'
    generates:
      - '{{.OUT_FILE}}'
    cmds:
      - mkdir -p {{dir .OUT_FILE}}
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/{{.TEMPLATE}}.yml.j2
        > {{.OUT_FILE}}

  kustomization:
    aliases: [ks]
    requires:
      vars: [APP]
    dir: '{{.APP_DIR}}'
    generates:
      - '{{.APP_DIR}}/kustomization.yml'
    cmds:
      - task: minijinja
        vars:
          TEMPLATE: kustomization
          OUT_FILE: '{{.APP_DIR}}/kustomization.yml'

  app:
    requires:
      vars: [APP, NS]
    dir: './apps/{{.NS}}'
    vars:
      OUT_FILE: './{{.APP}}/app.yml'
    generates:
      - './apps/{{.NS}}/{{.OUT_FILE}}'
    cmds:
      - task: minijinja
        vars:
          TEMPLATE: app
          OUT_FILE: './apps/{{.NS}}/{{.OUT_FILE}}'
      - kustomize edit add resource {{.OUT_FILE}}

  helm-app:
    requires:
      vars: [APP, NS]
    dir: './apps/{{.NS}}'
    vars:
      OUT_FILE: './{{.APP}}/app.yml'
    generates:
      - './apps/{{.NS}}/{{.OUT_FILE}}'
    cmds:
      - task: minijinja
        vars:
          TEMPLATE: helm
          OUT_FILE: './apps/{{.NS}}/{{.OUT_FILE}}'
      - kustomize edit add resource {{.OUT_FILE}}

  app-resources:
    requires:
      vars: [APP, IMG, PORT, NS]
    dir: '{{.APP_DIR}}'
    vars:
      OUT_FILE: './resources/{{.APP}}.yml'
    generates:
      - '{{.APP_DIR}}/{{.OUT_FILE}}'
    cmds:
      - task: minijinja
        vars:
          TEMPLATE: resources
          OUT_FILE: '{{.APP_DIR}}/{{.OUT_FILE}}'
      - kustomize edit add resource {{.OUT_FILE}}

  gatus:
    requires:
      vars: [APP, COMP, PROTO, NS]
    dir: '{{.APP_DIR}}'
    vars:
      OUT_FILE: './gatus.yml'
    generates:
      - '{{.APP_DIR}}/{{.OUT_FILE}}'
    cmds:
      - task: minijinja
        vars:
          TEMPLATE: gatus
          OUT_FILE: '{{.APP_DIR}}/{{.OUT_FILE}}'
      - kustomize edit add resource {{.OUT_FILE}}

  pvc:
    requires:
      vars: [APP, NS]
    dir: '{{.APP_DIR}}'
    vars:
      OUT_FILE: './resources/pvc.yml'
    generates:
      - '{{.APP_DIR}}/{{.OUT_FILE}}'
    cmds:
      - task: minijinja
        vars:
          TEMPLATE: pvc
          OUT_FILE: '{{.APP_DIR}}/{{.OUT_FILE}}'
      - kustomize edit add resource {{.OUT_FILE}}

  namespace:
    aliases: [ns]
    requires:
      vars: [NS]
    dir: './apps'
    generates:
      - './apps/{{.NS}}/kustomization.yml'
      - './apps/{{.NS}}/common.yml'
    cmds:
      - task: minijinja
        vars:
          TEMPLATE: ns-kustomization
          OUT_FILE: './apps/{{.NS}}/kustomization.yml'
      - task: minijinja
        vars:
          TEMPLATE: common
          OUT_FILE: './apps/{{.NS}}/common.yml'
      - kustomize edit add resource ./{{.NS}}
